name: Build Godot-Git (32-bit)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Enable multilib, ccache and refresh mirrors
        run: |
          set -euxo pipefail
          if ! grep -q '^\[multilib\]' /etc/pacman.conf; then
            cat >> /etc/pacman.conf <<'EOF'
          [multilib]
          Include = /etc/pacman.d/mirrorlist
          EOF
          fi
          sed -i 's/!ccache/ccache/' /etc/makepkg.conf
          pacman-key --init || true
          pacman-key --populate archlinux || true
          pacman -Syu --noconfirm

      - name: Install build & runtime dependencies
        run: |
          set -euxo pipefail
          # core build deps (ensure these are present)
          pacman -S --noconfirm --needed base-devel git scons yasm setconf mold ccache

          # install a broad set of lib32 runtime deps (pacman will skip ones not found)
          PKG32=(
            lib32-brotli
            lib32-freetype2
            lib32-libglvnd
            lib32-libtheora
            lib32-libvorbis
            lib32-libwebp
            lib32-libxcursor
            lib32-libxi
            lib32-libxinerama
            lib32-libxrandr
            lib32-pcre2
            lib32-alsa-lib
            lib32-pulseaudio
            lib32-glib2
            lib32-graphite
            lib32-libsquish
            lib32-libwslay
            lib32-miniupnpc
            lib32-openxr
            pulse-native-provider
          )

          for p in "${PKG32[@]}"; do
            echo "attempting install: $p"
            pacman -S --noconfirm --needed "$p" || echo "package $p not found/available, skipping"
          done

      - name: Create build user and set permissions
        run: |
          set -euxo pipefail
          useradd -m builder || true
          chown -R builder:builder "$GITHUB_WORKSPACE"

      - name: Configure ccache
        run: |
          set -euxo pipefail
          export CCACHE_DIR=/ccache
          mkdir -p /ccache
          chown -R builder:builder /ccache
          ccache --set-config=max_size=25G
          ccache --set-config=compiler_check=content
          ccache --zero-stats

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /ccache
          key: ccache-godot32-git
          restore-keys: |
            ccache-godot32-git-

      - name: Build package as builder
        run: |
          set -euxo pipefail
          su - builder -c "
          export CCACHE_DIR=/ccache &&
          export CC='ccache gcc' &&
          export CXX='ccache g++' &&
          export CCACHE_BASEDIR=$GITHUB_WORKSPACE &&
          export MAKEFLAGS="-j$(nproc)" &&
          cd $GITHUB_WORKSPACE/godot32-git &&
          makepkg --noconfirm
          "

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: godot32-git-pkg
          path: "godot32-git/*.pkg.tar.zst"
